<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agendamento de Salas da EEGR</title>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background: #f4f4f4;
}
header {
    background: #0066cc;
    color: white;
    padding: 15px;
    text-align: center;
}
main {
    max-width: 800px;
    margin: 20px auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
label { display: block; margin-top: 10px; font-weight: bold; }
input, select, button {
    padding: 8px;
    margin-top: 5px;
    width: 100%;
    box-sizing: border-box;
}
button {
    background: #0066cc;
    color: white;
    border: none;
    cursor: pointer;
    margin-top: 15px;
}
button:hover { background: #004c99; }
.horario {
    padding: 5px;
    border-bottom: 1px solid #ddd;
}
.ocupado { color: red; }
.disponivel { color: green; }
/* Chat lateral */
#chat {
    position: fixed;
    right: -350px;
    top: 0;
    width: 350px;
    height: 100%;
    background: #fff;
    border-left: 2px solid #0066cc;
    transition: right 0.3s;
    display: flex;
    flex-direction: column;
}
#chat header {
    background: #0066cc;
    color: white;
    padding: 10px;
    text-align: center;
    font-weight: bold;
}
#contacts {
    max-height: 150px;
    overflow-y: auto;
    border-bottom: 1px solid #ddd;
}
.contact {
    padding: 8px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
}
.contact:hover {
    background: #f5f5f5;
}
#chatMessages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    background: #fafafa;
}
.message {
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 8px;
    max-width: 70%;
    word-wrap: break-word;
}
.sent { background: #0066cc; color: white; margin-left: auto; }
.received { background: #e0e0e0; color: black; margin-right: auto; }
#chat input {
    width: calc(100% - 20px);
    margin: 10px;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ddd;
}
#toggleChat {
    position: fixed;
    right: 10px;
    bottom: 10px;
    background: #0066cc;
    color: white;
    padding: 10px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
}

/* Estilo para o container do input com o olhinho */
.input-com-olhinho {
    position: relative;
    width: 100%;
}
.input-com-olhinho input {
    width: 100%;
    padding-right: 35px; /* espa√ßo para o √≠cone */
}
.input-com-olhinho .toggle-olhinho {
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    cursor: pointer;
    user-select: none;
    font-size: 18px;
    color: #666;
}
.input-com-olhinho .toggle-olhinho:hover {
    color: #000;
}
</style>
</head>
<body>
<header><h1>Sistema de Agendamento</h1></header>

<!-- Telas -->
<main id="telaInicial">
  <h2>Bem-vindo!</h2>
  <button onclick="mostrarCadastro()">Cadastrar</button>
  <button onclick="mostrarLogin()">Entrar</button>
</main>

<!-- Cadastro -->
<main id="telaCadastro" style="display:none;">
  <h2>Cadastrar Professor</h2>
  <label>Nome:</label>
  <input type="text" id="novoNome">

  <label>Senha (m√≠nimo 8 caracteres):</label>
  <div class="input-com-olhinho">
    <input type="password" id="novaSenha">
    <span class="toggle-olhinho" onclick="toggleSenha('novaSenha', this)">üëÅÔ∏è</span>
  </div>

  <label>Confirmar Senha:</label>
  <div class="input-com-olhinho">
    <input type="password" id="confirmaSenha">
    <span class="toggle-olhinho" onclick="toggleSenha('confirmaSenha', this)">üëÅÔ∏è</span>
  </div>

  <button onclick="cadastrar()">Cadastrar</button>
  <button onclick="voltarInicio()">Voltar</button>
</main>

<!-- Login -->
<main id="telaLogin" style="display:none;">
  <h2>Entrar</h2>
  <label>N√∫mero de Login:</label>
  <input type="number" id="loginNumero">

  <label>Senha:</label>
  <div class="input-com-olhinho">
    <input type="password" id="loginSenha">
    <span class="toggle-olhinho" onclick="toggleSenha('loginSenha', this)">üëÅÔ∏è</span>
  </div>

  <button onclick="entrar()">Entrar</button>
  <button onclick="voltarInicio()">Voltar</button>
</main>

<!-- Agendamento -->
<main id="telaAgendamento" style="display:none;">
  <h2>Agendamento de Salas</h2>
  <p id="usuarioLogado"></p>
  <label>Nome do Professor:</label>
  <input type="text" id="professor" readonly>
  <label>Mat√©ria:</label>
  <input type="text" id="materia">
  <label>Professor de curso t√©cnico?</label>
  <select id="tecnico">
    <option value="false">N√£o</option>
    <option value="true">Sim</option>
  </select>
  <label>Sala:</label><select id="sala"></select>
  <label>Dia:</label><select id="dia"></select>
  <label>Hor√°rio:</label><select id="horario"></select>
  <button onclick="agendar()">Agendar</button>
  <div id="listaHorarios"></div>
</main>

<!-- Chat -->
<div id="chat">
  <header>Chat de Professores</header>
  <div id="contacts"></div>
  <div id="chatHeader">Selecione um professor</div>
  <div id="chatMessages"></div>
  <input type="text" id="chatInput" placeholder="Digite..." onkeypress="if(event.key==='Enter')sendMessage()">
</div>
<div id="toggleChat" onclick="toggleChat()">üí¨</div>

<script>
const salas = ["Laborat√≥rio de Inform√°tica","Laborat√≥rio de Ci√™ncias","Sala de V√≠deo","Audit√≥rio"];
const dias = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta"];
const horarios = ["07:00","07:50","08:40","09:30","10:20","11:10","13:00","13:50","14:40","15:30","16:20","17:10","19:00","19:50","20:40","21:30","22:20"];
let usuario=null,currentChat=null;

function mostrarCadastro(){tela("telaCadastro");}
function mostrarLogin(){tela("telaLogin");}
function voltarInicio(){tela("telaInicial");usuario=null;currentChat=null;}

function tela(id){
  ["telaInicial","telaCadastro","telaLogin","telaAgendamento"].forEach(t=>document.getElementById(t).style.display="none");
  document.getElementById(id).style.display="block";
}

function toggleSenha(id,icon){
  const i=document.getElementById(id);
  i.type=i.type==="password"?"text":"password";
}

function cadastrar(){
  const nome=novoNome.value.trim(),senha=novaSenha.value,conf=confirmaSenha.value;
  if(!nome)return alert("Digite o nome!");
  if(senha.length<8)return alert("Senha deve ter no m√≠nimo 8 caracteres.");
  if(senha!==conf)return alert("As senhas n√£o conferem.");
  fetch("http://localhost:3000/api/cadastrar",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({nome,senha})
  }).then(r=>r.json()).then(d=>{
    if(d.sucesso){
      alert(`Cadastro realizado! Seu n√∫mero de login √© ${d.id}`);
      voltarInicio();
    }else alert(d.mensagem);
  }).catch(()=>alert("Erro de conex√£o."));
}

function entrar(){
  const id=parseInt(loginNumero.value),senha=loginSenha.value;
  if(!id||!senha)return alert("Digite login e senha!");
  fetch("http://localhost:3000/api/login",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({id,senha})
  }).then(r=>r.json()).then(d=>{
    if(d.sucesso){
      usuario=d.professor;
      usuarioLogado.textContent=`Logado como: ${usuario.nome} (ID ${usuario.id})`;
      professor.value=usuario.nome;
      tela("telaAgendamento");
      carregarSelects();carregarAgenda();loadContacts();
    }else alert(d.mensagem);
  }).catch(()=>alert("Erro de conex√£o."));
}

function carregarSelects(){
  if(!sala.options.length)salas.forEach(s=>sala.add(new Option(s,s)));
  if(!dia.options.length)dias.forEach(d=>dia.add(new Option(d,d)));
  if(!horario.options.length)horarios.forEach(h=>horario.add(new Option(h,h)));
  sala.onchange=dia.onchange=horario.onchange=carregarAgenda;
}

function carregarAgenda(){
  if(!usuario)return;
  const s=sala.value,d=dia.value;
  fetch(`http://localhost:3000/api/agendamentos/${usuario.id}`)
    .then(r=>r.json()).then(data=>{
      if(!data.sucesso)return;
      listaHorarios.innerHTML="";
      const filtrados=data.agendamentos.filter(a=>a.dia===d&&a.sala===s);
      horarios.forEach(h=>{
        const ag=filtrados.find(a=>a.horario===h);
        if(ag){
          const div=document.createElement("div");
          div.className="horario ocupado";
          div.textContent=`${h} - ${ag.materia} (${ag.tecnico?"T√©cnico":"N√£o T√©cnico"})`;
          listaHorarios.appendChild(div);
        }
      });
    });
}

function agendar(){
  if(!usuario)return alert("Fa√ßa login!");
  const materia=materiaInput=materia.value.trim();
  if(!materia)return alert("Preencha a mat√©ria!");
  fetch("http://localhost:3000/api/agendar",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({professor_id:usuario.id,materia,tecnico:tecnico.value==="true",sala:sala.value,dia:dia.value,horario:horario.value})
  }).then(r=>r.json()).then(d=>{
    if(d.sucesso){alert("Agendado!");carregarAgenda();}
    else alert(d.mensagem);
  });
}

// Chat
function toggleChat(){chat.style.right=chat.style.right==="0px"?"-350px":"0px";}
function loadContacts(){
  fetch("http://localhost:3000/api/professores").then(r=>r.json()).then(d=>{
    if(!d.sucesso)return;
    contacts.innerHTML="";
    d.professores.filter(p=>p.id!==usuario.id).forEach(u=>{
      const div=document.createElement("div");
      div.className="contact";div.textContent=u.nome;
      div.onclick=()=>openChat(u);contacts.appendChild(div);
    });
  });
}
function openChat(u){currentChat=u;chatHeader.textContent=`Conversando com ${u.nome}`;carregarMensagens();}
function carregarMensagens(){
  fetch(`http://localhost:3000/api/chat/mensagens?user1=${usuario.id}&user2=${currentChat.id}`)
    .then(r=>r.json()).then(d=>{
      chatMessages.innerHTML="";
      d.mensagens.forEach(m=>{
        const div=document.createElement("div");
        div.className="message "+(m.remetente_id===usuario.id?"sent":"received");
        div.textContent=m.mensagem;chatMessages.appendChild(div);
      });
      chatMessages.scrollTop=chatMessages.scrollHeight;
    });
}
function sendMessage(){
  const texto=chatInput.value.trim();
  if(!texto)return;
  fetch("http://localhost:3000/api/chat/enviar",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({remetente_id:usuario.id,destinatario_id:currentChat.id,mensagem:texto})
  }).then(r=>r.json()).then(d=>{
    if(d.sucesso){chatInput.value="";carregarMensagens();}
  });
}
</script>
</body>
</html>